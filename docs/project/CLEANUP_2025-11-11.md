# Codebase Cleanup - November 11, 2025

## Summary

Rigorous cleanup and reorganization of the entire codebase to improve maintainability and clarity.

## Changes Made

### 1. Root Directory Cleanup

**Moved files to appropriate locations:**
- `ATI_MQTT_DIRECT_ACCESS.md` → `docs/integrations/ati/`
- `start_bridges.py` → `scripts/`
- `start_multi_plant_streaming.bat` → `scripts/`
- `transform_analysis.png` → `movement_images/`

**Archived:**
- `NEW_AFFINE_PARAMS.txt` → `archive/` (temporary calculation file)

**Removed:**
- `RENDER_DEPLOYMENT.md` (duplicate, kept version in docs/deployment/)

### 2. Tests Directory Reorganization

**Removed duplicates:**
- `tests/test_docker_bridge.py` (duplicate of `tests/integration/test_docker_bridge.py`)
- `tests/test_final_format.py` (duplicate of `tests/integration/test_final_format.py`)
- `tests/test_working_localization.py` (duplicate of `tests/integration/test_working_localization.py`)

**Archived old TVS tests:**
- `tests/tvs/tvs_comprehensive_test.py`
- `tests/tvs/tvs_comprehensive_verification.py`
- `tests/tvs/tvs_exhaustive_topic_test.py`
- `tests/tvs/tvs_extensive_data_test.py`
- `tests/tvs/tvs_focused_verification.py`
- `tests/tvs/tvs_publisher_test.py`
- `tests/tvs/tvs_unique_client_test.py`

All moved to: `archive/tvs_tests_old/`

**Kept active:**
- `tests/tvs/tvs_quick_check.py`
- `tests/tvs/data_structure_comparison.py`

**Archived render tests:**
- Entire `tests/render/` directory moved to `archive/render_tests/` (render deployment not in use)

### 3. Scripts Reorganization

**Created new structure:**
```
scripts/
├── deployment/       # Deployment scripts
├── monitoring/       # System monitoring
├── setup/            # Initial setup scripts
├── transformation/   # NEW: Coordinate transformation scripts
├── utils/            # General utilities
└── verification/     # System verification
```

**Moved to `scripts/transformation/`:**
- `analyze_log_data.py`
- `analyze_movement_coordinates.py`
- `calculate_affine_transform.py`
- `calculate_offset_correction.py`
- `overlay_paths_on_map.py`
- `recalculate_transform_precise.py`
- `test_coordinate_transform.py`
- `validate_transformation_live.py`
- `visualize_transform_errors.py`

**Kept in `scripts/utils/`:**
- `expose_mqtt.py`
- `manage_twinzo_devices.py`
- `setup_hitech_tuggers.py`
- `test_manual_post.py`

### 4. Documentation Consolidation

**Archived outdated ATI integration docs:**
- `ATI_DIRECT_INTEGRATION_PLAN.md`
- `ATI_INTEGRATION_SIMPLE.md`
- `ATI_MQTT_INTEGRATION_GUIDE.md`
- `ATI_ORIGINAL_DOCUMENTATION.md`
- `ATI_WEBSOCKET_INTEGRATION.md`

All moved to: `archive/ati_docs_old/`

**Kept current ATI docs:**
- `ATI_COMPLETE_INTEGRATION_GUIDE.md` (comprehensive guide)
- `ATI_MQTT_DIRECT_ACCESS.md` (for Twinzo team)

**Archived old deployment docs:**
- `FREE_MQTT_HOSTING_ALTERNATIVES.md`
- `HOSTING_ALTERNATIVES.md`
- `PERSISTENT_MQTT_HOSTING.md`

All moved to: `archive/deployment_docs_old/`

**Kept current:**
- `RENDER_DEPLOYMENT.md` (in docs/deployment/)

### 5. Integration Cleanup

**Archived failed websocket attempts:**
- `integrations/ati/websocket_ati_publisher.py`
- `integrations/ati/websocket_bridge_subscriber.py`
- `integrations/ati/websocket_bridge_to_twinzo.py`
- `tests/ati/diagnose_websocket.py`

All moved to: `archive/websocket_attempts/`

**Kept active integrations:**
- `integrations/ati/audit_feed_explorer.py` (ATI MQTTS audit feed)
- `integrations/ati/setup_ati_broker.py`
- `integrations/ati/simulate_ati_publisher.py`
- `integrations/tvs/*` (TVS integration scripts)
- `integrations/twinzo/*` (Twinzo utilities)

### 6. .gitignore Updates

**Added patterns for:**
- Mosquitto runtime data (`config/mosquitto/data/`, `config/mosquitto/log/`)
- Database files (`*.db`, `*.db-journal`)
- Runtime data directories (`data/ati_mqtt/`, `data/mqtt/`, `data/websocket_mqtt/`)
- Generated movement analysis plots (keeping only twinzo-map.png)
- Log files (keeping directory structure with .gitkeep)
- Temporary calculation files

## Current Structure

### Clean Root Directory
```
twinzo-mock/
├── .env                         # Environment configuration
├── .env.example                 # Example configuration
├── .gitignore                   # Updated with new patterns
├── CLAUDE.md                    # Project instructions
├── README.md                    # Main documentation
├── docker-compose.yml           # Docker configuration
├── package.json                 # Node.js dependencies
├── render.yaml                  # Render deployment config
├── archive/                     # Archived old code
├── config/                      # Configuration files
├── data/                        # Runtime data (gitignored)
├── deployments/                 # Deployment configurations
├── docs/                        # Documentation
├── integrations/                # External integrations
├── logs/                        # Application logs
├── movement_images/             # Coordinate analysis visualizations
├── node_modules/                # Node.js packages
├── scripts/                     # Utility scripts (reorganized)
├── src/                         # Core application code
└── tests/                       # Test files (cleaned up)
```

### Scripts Organization
```
scripts/
├── deployment/        # Railway, ngrok, local deployment
├── monitoring/        # System and Twinzo monitoring
├── setup/             # Initial setup and configuration
├── transformation/    # Coordinate transformation (NEW)
├── utils/             # General utilities
├── verification/      # System verification
├── start_bridges.py   # Bridge starter script (moved from root)
└── start_multi_plant_streaming.bat  # Windows starter
```

### Tests Organization
```
tests/
├── ati/               # ATI integration tests
├── integration/       # End-to-end integration tests
├── mqtt/              # MQTT connectivity tests
├── tvs/               # TVS integration tests (reduced to essentials)
└── unit/              # Unit tests
```

### Documentation Organization
```
docs/
├── deployment/        # Deployment guides (consolidated)
├── guides/            # User guides
├── integrations/      # Integration documentation
│   ├── ati/          # ATI docs (consolidated to 2 key files)
│   ├── hitech/       # HiTech plant docs
│   └── tvs/          # TVS client docs
├── project/          # Project management docs
└── reference/        # Reference materials
```

## Benefits

1. **Cleaner root directory** - Only essential config and documentation files
2. **Better scripts organization** - Transformation scripts now grouped logically
3. **Reduced test redundancy** - No duplicate tests, archived old experiments
4. **Consolidated documentation** - Removed outdated docs, kept only current guides
5. **Archived instead of deleted** - All old code preserved for reference
6. **Improved .gitignore** - Runtime files properly excluded from git

## Files Kept Active

### Production Code
- `src/bridge/bridge_audit_feed.js` - **PRODUCTION** Old Plant bridge (Node.js)
- `src/bridge/bridge_hitech.py` - HiTech Plant bridge
- `src/bridge/bridge_old_plant.py` - Alternative Old Plant bridge (Python)

### Active Scripts
- `scripts/start_bridges.py` - Multi-plant bridge launcher
- `scripts/transformation/*` - All coordinate transformation utilities
- `scripts/monitoring/monitor_twinzo.py` - Production monitoring
- `scripts/utils/manage_twinzo_devices.py` - Device management API

### Active Documentation
- `CLAUDE.md` - Project instructions (updated with new transformation)
- `docs/PRODUCTION_SETUP.md` - Production deployment guide
- `docs/integrations/ati/ATI_COMPLETE_INTEGRATION_GUIDE.md` - Comprehensive ATI guide
- `docs/integrations/ati/ATI_MQTT_DIRECT_ACCESS.md` - For Twinzo team
- `docs/TRANSFORMATION_UPDATE.md` - Latest transformation calculations

## Archive Locations

| Old Location | Archive Location | Reason |
|--------------|------------------|--------|
| Root files | `archive/` | Temporary calculation files |
| TVS tests | `archive/tvs_tests_old/` | Outdated comprehensive tests |
| Render tests | `archive/render_tests/` | Render deployment not in use |
| Websocket attempts | `archive/websocket_attempts/` | Failed integration approach |
| ATI docs | `archive/ati_docs_old/` | Superseded by current guides |
| Deployment docs | `archive/deployment_docs_old/` | Outdated hosting research |

## Next Steps

1. ✅ Root cleanup complete
2. ✅ Tests reorganized
3. ✅ Scripts restructured
4. ✅ Documentation consolidated
5. ✅ Integrations cleaned up
6. ✅ .gitignore updated
7. ✅ README files updated

## Maintenance Notes

- **Archive policy**: Never delete code, always archive for reference
- **Script organization**: Transformation scripts now have dedicated directory
- **Documentation**: Keep only 1-2 most current guides per topic
- **Tests**: Remove duplicates immediately, archive old experiments
- **.gitignore**: Keep runtime data out of git (logs, databases, temp files)
